<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
	"http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.poozim.jobcall.mapper.WorkMapper">
	
	<sql id="selectBoard">
		<if test="work_seq != null and work_seq != ''"> AND b.work_seq = #{work_seq}</if>
		<if test="group_seq != null and group_seq != ''"> AND b.group_seq = #{group_seq}</if>
		<if test="seq != null and seq != ''"> AND b.seq = #{seq}</if>
	</sql>

	<sql id="selectActionLog">
		<if test="action != null and action != ''">AND action = #{action}</if>
		<if test="target != null and target != ''">AND target = #{target}</if>
		<if test="target_seq != null and target_seq != ''">AND target_seq = #{target_seq}</if>
		<if test="member_seq != null and member_seq != ''">AND member_seq = #{member_seq}</if>
	</sql>

	<select id="getWorkGroupList" parameterType="WorkGroup" resultType="WorkGroup">
		SELECT wg.*, 
		(SELECT category_seq FROM WorkCategoryGroup wcg WHERE wcg.group_seq = wg.seq AND wcg.member_seq = #{member_seq}) as category_seq
		FROM WorkGroup wg
		WHERE wg.useyn = 'Y'
		AND wg.work_seq = #{work_seq}
		AND 
		(	
			wg.access like 'public'
			OR	
			(wg.access like 'private' AND wg.seq IN (SELECT group_seq FROM WorkGroupMember WHERE member_seq = #{member_seq}))
		)
	</select>
	
	<select id="getWorkBoardList" parameterType="WorkBoard" resultMap="workBoardMap">
		SELECT *, 'board' as target, 'like' as `like`, 'dislike' as dislike, #{member_seq} as search_member_seq, #{comment_limit} as comment_limit,
		(SELECT c.seq FROM Comment c WHERE c.board_seq = b.seq ORDER BY c.seq ASC LIMIT 1) as first_comment_seq,
		(SELECT action FROM ActionLog al WHERE al.member_seq = #{member_seq} AND al.target LIKE 'board' AND al.target_seq = b.seq) as action,
		(SELECT al.seq FROM ActionLog al WHERE al.member_seq = #{member_seq} AND al.target LIKE 'board' AND al.target_seq = b.seq) as actionLog_seq
		<choose>
			<when test="comment_offset != null and comment_offset != ''">
				, #{comment_offset} as comment_offset
			</when>
			<otherwise>
				,(SELECT IF(COUNT(c2.seq) > #{comment_limit}, COUNT(c2.seq)-#{comment_limit}, 0) FROM Comment c2 WHERE c2.board_seq = b.seq) as comment_offset
			</otherwise>
		</choose>
		FROM WorkBoard b, WorkGroupMember gm
		WHERE b.group_seq = gm.group_seq
		AND b.group_seq = #{group_seq}
		AND gm.member_seq = #{member_seq}
		<include refid="selectBoard" />
		ORDER BY b.regdate DESC
		LIMIT #{limit} OFFSET #{offset}
	</select>
	
	<select id="getWorkBoardCount" parameterType="WorkBoard" resultType="int">
		SELECT COUNT(*)
		FROM WorkBoard b, WorkGroupMember gm
		WHERE b.group_seq = gm.group_seq
		AND b.group_seq = #{group_seq}
		AND gm.member_seq = #{member_seq}
		<include refid="selectBoard" />
	</select>
	
	<select id="getWorkBoardOne" parameterType="WorkBoard" resultMap="workBoardMap">
		SELECT *, 'board' as target, 'like' as `like`, 'dislike' as dislike, #{member_seq} as search_member_seq, #{comment_limit} as comment_limit,
		(SELECT c.seq FROM Comment c WHERE c.board_seq = b.seq ORDER BY c.seq ASC LIMIT 1) as first_comment_seq,
		(SELECT action FROM ActionLog al WHERE al.member_seq = #{member_seq} AND al.target LIKE 'board' AND al.target_seq = b.seq) as action,
		(SELECT al.seq FROM ActionLog al WHERE al.member_seq = #{member_seq} AND al.target LIKE 'board' AND al.target_seq = b.seq) as actionLog_seq
		<choose>
			<when test="comment_offset != null and comment_offset != ''">
				, #{comment_offset} as comment_offset
			</when>
			<otherwise>
				,(SELECT IF(COUNT(c2.seq) > #{comment_limit}, COUNT(c2.seq)-#{comment_limit}, 0) FROM Comment c2 WHERE c2.board_seq = b.seq) as comment_offset
			</otherwise>
		</choose>
		FROM WorkBoard b
		WHERE b.seq = #{seq}
	</select>
	
	<select id="getWorkBoardFileList" resultType="WorkBoardFile">
		SELECT *
		FROM WorkBoardFile
		WHERE board_seq = #{board_seq}
	</select>
	
	<resultMap type="WorkBoard" id="workBoardMap">
		<result property="seq" column="seq" />
		<result property="member_seq" column="member_seq" />
		<result property="member_id" column="member_id" />
		<result property="member_name" column="member_name" />
		<result property="work_seq" column="work_seq" />
		<result property="group_seq" column="group_seq" />
		<result property="title" column="title" />
		<result property="type" column="type" />
		<result property="startdate" column="startdate" />
		<result property="enddate" column="enddate" />
		<result property="worker" column="worker" />
		<result property="content" column="content" />
		<result property="status" column="status" />
		<result property="register" column="register" />
		<result property="regdate" column="regdate" />
		<result property="target" column="target" />
		<result property="like" column="like" />
		<result property="dislike" column="dislike" />
		<result property="search_member_seq" column="search_member_seq" />
		<result property="comment_offset" column="comment_offset" />
		<result property="comment_limit" column="comment_limit" />
		<collection property="likeList" column="{action=like, target=target, target_seq=seq}" javaType="java.util.ArrayList" ofType="ActionLog" select="getActionLogList"></collection>
		<collection property="dislikeList" column="{action=dislike, target=target, target_seq=seq}" javaType="java.util.ArrayList" ofType="ActionLog" select="getActionLogList"></collection>
		<collection property="workBoardFileList" column="{board_seq=seq}" javaType="java.util.ArrayList" ofType="WorkBoardFile" select="getWorkBoardFileList"></collection>
		<collection property="commentList" column="{board_seq=seq, search_member_seq=search_member_seq, init_offset=comment_offset, limit=comment_limit}" javaType="java.util.ArrayList" ofType="Comment" select="getCommentList"></collection>
		<collection property="boardVoteList" column="{board_seq=seq, search_member_seq=search_member_seq}" javaType="java.util.ArrayList" ofType="BoardVote" select="getBoardVoteList"></collection>
	</resultMap>
	
	<select id="getWorkCategoryList" parameterType="WorkCategory" resultType="WorkCategory">
		SELECT wc.*, 
			(SELECT COUNT(*) FROM WorkCategoryGroup wcg WHERE wcg.category_seq = wc.seq AND wcg.member_seq = #{member_seq}) as group_count
		FROM WorkCategory wc
		WHERE wc.defaultyn = 'Y'
		OR wc.member_seq = #{member_seq}
	</select>
	
	<update id="moveWorkGroupList" parameterType="WorkCategoryGroup">
		UPDATE WorkCategoryGroup
		SET category_seq = #{category_seq}
		WHERE member_seq = #{member_seq}
		<if test="groupSeqList != null and groupSeqList != ''">
			AND group_seq IN
			<foreach collection="groupSeqList" item="groupseq" open="(" close=")" separator=" , " index="i">
				#{groupseq}
			</foreach>
		</if>
	</update>
	
	<insert id="insertWorkGroupMemberList" parameterType="WorkGroupMember">
		INSERT INTO WorkGroupMember (
			group_seq,
			member_seq,
			regdate
		) VALUES 
		<if test="memberSeqList != null and memberSeqList != ''">
			<foreach collection="memberSeqList" item="memberseq" open="" close="" separator=" , " index="i">
				(#{group_seq}, #{memberseq}, #{regdate})
			</foreach>
		</if>
		
	</insert>
	
	<select id="getCreatedWorkCode" parameterType="String" resultType="String">
		SELECT getWorkCode(#{title}) as code
	</select>
	
	<select id="getCommentList" resultMap="CommentMap">
		SELECT *, 'comment' as target, 'like' as `like`, 'dislike' as dislike,
		(SELECT action FROM ActionLog al WHERE al.member_seq = #{search_member_seq} AND al.target LIKE 'comment' AND al.target_seq = c.seq) as action,
		(SELECT al.seq FROM ActionLog al WHERE al.member_seq = #{search_member_seq} AND al.target LIKE 'comment' AND al.target_seq = c.seq) as actionLog_seq
		FROM Comment c
		WHERE board_seq = #{board_seq}
		ORDER BY c.regdate ASC
		<choose>
			<when test="offset != null and offset != ''">
				LIMIT #{limit} OFFSET #{offset}
			</when>
			<otherwise>
				LIMIT #{limit} OFFSET #{init_offset}
			</otherwise>
		</choose>
	</select>
	
	<select id="getCommentOne" resultMap="CommentMap">
		SELECT *, 'comment' as target, 'like' as `like`, 'dislike' as dislike,
		(SELECT action FROM ActionLog al WHERE al.member_seq = #{search_member_seq} AND al.target LIKE 'comment' AND al.target_seq = c.seq) as action,
		(SELECT al.seq FROM ActionLog al WHERE al.member_seq = #{search_member_seq} AND al.target LIKE 'comment' AND al.target_seq = c.seq) as actionLog_seq
		FROM Comment c
		WHERE c.seq = #{seq}
	</select>
	
	<select id="getCommentFileList" resultType="CommentFile">
		SELECT *
		FROM CommentFile
		WHERE comment_seq = #{comment_seq}
	</select>
	
	<resultMap type="Comment" id="CommentMap">
		<result property="seq" column="seq" />
		<result property="board_seq" column="board_seq" />
		<result property="member_seq" column="member_seq" />
		<result property="member_id" column="member_id" />
		<result property="member_name" column="member_name" />
		<result property="content" column="content" />
		<result property="register" column="register" />
		<result property="regdate" column="regdate" />
		<result property="modifier" column="modifier" />
		<result property="moddate" column="moddate" />
		<result property="target" column="target" />
		<result property="like" column="like" />
		<result property="dislike" column="dislike" />
		<collection property="likeList" column="{action=like, target=target, target_seq=seq}" javaType="java.util.ArrayList" ofType="ActionLog" select="getActionLogList"></collection>
		<collection property="dislikeList" column="{action=dislike, target=target, target_seq=seq}" javaType="java.util.ArrayList" ofType="ActionLog" select="getActionLogList"></collection>
		<collection property="commentFileList" column="{comment_seq=seq}" javaType="java.util.ArrayList" ofType="CommentFile" select="getCommentFileList"></collection>
	</resultMap>
	
	<select id="getActionLogList" resultType="ActionLog">
		SELECT *
		FROM ActionLog
		WHERE 1 = 1
		<include refid="selectActionLog" />		
	</select>
	
	<select id="getBoardVoteList" resultMap="BoardVoteMap">
		SELECT bv.* ,
			IF((SELECT COUNT(*) FROM BoardVoteMember bvm WHERE bvm.member_seq = #{search_member_seq} AND bvm.vote_seq = bv.seq AND bvm.board_seq = #{board_seq}) > 0 , 'Y', 'N') as voteyn
		FROM BoardVote bv
		WHERE bv.board_seq = #{board_seq}
	</select>
	
	<select id="getBoardVoteMemberList" resultType="BoardVoteMember">
		SELECT *
		FROM BoardVoteMember
		WHERE vote_seq = #{vote_seq}
	</select>
	
	<resultMap type="BoardVote" id="BoardVoteMap">
		<result property="seq" column="seq" /> 
		<collection property="boardVoteMemberList" column="{vote_seq=seq}" javaType="java.util.ArrayList" ofType="BoardVoteMember" select="getBoardVoteMemberList"></collection>
	</resultMap>
	
</mapper>